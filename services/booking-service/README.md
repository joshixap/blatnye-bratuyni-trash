# Booking Service - Система бронирования коворкинга "ПУНККроссинг"

## Обзор

Микросервис для управления зонами коворкинга, местами, слотами времени и бронированиями. Построен на FastAPI с асинхронной работой с PostgreSQL.

## Технологический стек

- **Framework**: FastAPI
- **Язык**: Python 3.11+
- **База данных**: PostgreSQL (через SQLAlchemy 2.0)
- **ORM**: SQLAlchemy с async поддержкой
- **Валидация**: Pydantic v2

## Структура проекта

```
services/booking-service/
├── main.py              # Точка входа приложения
├── models.py            # SQLAlchemy модели (Zone, Place, Slot, Booking)
├── schemas.py           # Pydantic схемы для валидации
├── crud.py              # CRUD операции с БД
├── routes.py            # Публичные эндпоинты
├── admin.py             # Админские эндпоинты
├── db.py                # Настройка подключения к БД
├── security.py          # Проверка прав доступа
├── config.py            # Конфигурация
├── requirements.txt     # Python зависимости
├── Dockerfile           # Docker образ
└── README.md
```

## Основные функции

### Публичные эндпоинты (routes.py)

- **Просмотр зон** (`GET /zones`):
  - Список всех активных зон коворкинга
  
- **Просмотр мест** (`GET /zones/{zone_id}/places`):
  - Список мест в конкретной зоне
  
- **Просмотр слотов** (`GET /places/{place_id}/slots?date={date}`):
  - Доступные временные слоты для места на дату

- **Создание бронирования** (`POST /bookings`):
  - Бронирование конкретного слота (старый метод)
  
- **Создание бронирования по времени** (`POST /bookings/by-time`):
  - Бронирование по диапазону времени для зоны
  - Автоматический выбор свободного места
  - Проверка лимита в 6 часов
  - Сохранение информации о зоне в бронировании

- **Отмена бронирования** (`POST /bookings/cancel`):
  - Отмена активного бронирования

- **История бронирований** (`GET /bookings/history`):
  - Список бронирований с фильтрацией

- **Продление бронирования** (`POST /bookings/{booking_id}/extend`):
  - Продление на следующий слот

### Админские эндпоинты (admin.py)

- **Создание зоны** (`POST /admin/zones`):
  - Создание новой зоны с автоматическим созданием N мест
  - Требуется роль администратора
  
- **Обновление зоны** (`PATCH /admin/zones/{zone_id}`):
  - Изменение параметров зоны

- **Удаление зоны** (`DELETE /admin/zones/{zone_id}`):
  - Полное удаление зоны со всеми связями

- **Закрытие зоны** (`POST /admin/zones/{zone_id}/close`):
  - Временное закрытие на обслуживание
  - Автоматическая отмена всех бронирований в интервале

## Модели данных

### Zone (Зона)
- Название и адрес коворкинга
- Статус активности
- Связь с местами (one-to-many)

### Place (Место)
- Привязка к зоне
- Название места (например, "Место 1")
- Статус активности

### Slot (Слот времени)
- Привязка к месту
- Временной интервал (start_time, end_time)
- Флаг доступности

### Booking (Бронирование)
- Привязка к пользователю и слоту
- Денормализованные данные: zone_name, zone_address, start_time, end_time
- Статус (active / cancelled / completed)

## API интеграция

Сервис взаимодействует через API Gateway. Авторизация передается через заголовки:
- `X-User-Id` - ID пользователя
- `X-User-Role` - Роль пользователя (user / admin)

## Установка и запуск

### Требования

- Python 3.11+
- PostgreSQL 14+

### Установка зависимостей

```bash
cd services/booking-service
pip install -r requirements.txt
```

### Настройка окружения

Создайте файл `.env`:

```env
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/booking_db
```

### Режим разработки

```bash
uvicorn main:app --reload --port 8001
```

Приложение будет доступно на `http://localhost:8001`.

### Продакшн сборка

```bash
uvicorn main:app --host 0.0.0.0 --port 8001
```

## Особенности реализации

### Асинхронность

- Все операции с БД выполняются асинхронно
- Использование `AsyncSession` для подключений
- Поддержка высокой нагрузки

### Автоматическое создание мест

При создании зоны админ указывает `places_count`, и система автоматически создает N мест с названиями "Место 1", "Место 2" и т.д.

### Бронирование по времени

Новый метод бронирования позволяет:
1. Выбрать зону и временной диапазон
2. Система автоматически находит свободное место
3. Проверяет лимит в 6 часов
4. Создает слот и бронирование с сохранением информации о зоне

### Денормализация данных

Для удобства в бронировании сохраняются:
- Название зоны
- Адрес зоны
- Время начала и окончания

Это позволяет избежать лишних JOIN-ов при получении истории бронирований.

## Интеграция с Docker

Для запуска вместе с остальными сервисами используется `docker-compose.yaml`:

```yaml
booking-service:
  build: ./services/booking-service
  container_name: coworking-booking
  ports:
    - "8001:8001"
  environment:
    - DATABASE_URL=postgresql+asyncpg://user:password@postgres:5432/booking_db
  depends_on:
    - postgres
```

## Troubleshooting

### Проблема: Ошибки подключения к БД

**Решение**: Проверьте `DATABASE_URL` в конфигурации:

```python
DATABASE_URL = "postgresql+asyncpg://user:password@localhost:5432/db"
```

### Проблема: 401 ошибки при вызове админских эндпоинтов

**Решение**: Убедитесь, что передается заголовок `X-User-Role: admin`

### Проблема: Конфликты при создании слотов

**Решение**: Проверьте уникальное ограничение на (place_id, start_time, end_time)

## Планы развития

- [ ] Добавить пакетное создание слотов для мест
- [ ] Реализовать повторяющиеся бронирования
- [ ] Добавить систему скидок и тарифов
- [ ] Интегрировать с платежной системой
- [ ] Добавить систему уведомлений о предстоящих бронированиях

## Контакты и поддержка

Для вопросов и предложений создавайте issues в репозитории проекта.

---

**Версия**: 0.1.0  
**Дата последнего обновления**: 2025-12-07
