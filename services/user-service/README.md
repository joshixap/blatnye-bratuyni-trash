# User Service - Система бронирования коворкинга "ПУНККроссинг"

## Обзор

Микросервис для управления пользователями: регистрация, аутентификация, подтверждение email и восстановление пароля. Построен на FastAPI с PostgreSQL.

## Технологический стек

- **Framework**: FastAPI
- **Язык**: Python 3.11+
- **База данных**: PostgreSQL (через SQLAlchemy)
- **Аутентификация**: JWT (JSON Web Tokens)
- **Хеширование паролей**: bcrypt
- **Email**: SMTP для отправки кодов подтверждения

## Структура проекта

```
services/user-service/
├── main.py              # Точка входа приложения
├── models.py            # SQLAlchemy модели (User)
├── crud.py              # CRUD операции с БД
├── routes.py            # API эндпоинты
├── auth.py              # JWT и хеширование паролей
├── email_utils.py       # Отправка email
├── config.py            # Конфигурация
├── requirements.txt     # Python зависимости
├── Dockerfile           # Docker образ
└── README.md
```

## Основные функции

### Регистрация и подтверждение

- **Регистрация** (`POST /register`):
  - Создание нового пользователя
  - Генерация 6-значного кода подтверждения
  - Отправка кода на email
  - Пароль хешируется с помощью bcrypt

- **Подтверждение email** (`POST /confirm`):
  - Ввод кода подтверждения
  - Активация аккаунта

### Аутентификация

- **Вход** (`POST /login`):
  - Проверка email и пароля
  - Генерация JWT токена
  - Возврат access_token

### Восстановление пароля

- **Запрос восстановления** (`POST /recover`):
  - Генерация кода восстановления
  - Отправка кода на email

- **Сброс пароля** (`POST /reset`):
  - Проверка кода восстановления
  - Установка нового пароля

## Модели данных

### User (Пользователь)

- `id` - Уникальный идентификатор
- `name` - Имя пользователя
- `email` - Email (уникальный)
- `password_hash` - Хешированный пароль
- `confirmed` - Флаг подтверждения email
- `is_admin` - Флаг администратора
- `confirmation_code` - Временный код подтверждения
- `recovery_code` - Временный код восстановления
- `created_at` - Дата создания

## API интеграция

Сервис взаимодействует через API Gateway на `http://localhost:8000/users/*`.

### Эндпоинты

- `POST /users/register` - Регистрация нового пользователя
- `POST /users/confirm` - Подтверждение email кодом
- `POST /users/login` - Вход в систему (получение JWT)
- `POST /users/recover` - Запрос кода восстановления пароля
- `POST /users/reset` - Сброс пароля по коду

## Установка и запуск

### Требования

- Python 3.11+
- PostgreSQL 14+
- SMTP сервер для отправки email

### Установка зависимостей

```bash
cd services/user-service
pip install -r requirements.txt
```

### Настройка окружения

Создайте файл `.env`:

```env
DATABASE_URL=postgresql://user:password@localhost:5432/users_db
JWT_SECRET=your-secret-key
JWT_ALGORITHM=HS256
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-password
```

### Режим разработки

```bash
uvicorn main:app --reload --port 8002
```

Приложение будет доступно на `http://localhost:8002`.

### Продакшн сборка

```bash
uvicorn main:app --host 0.0.0.0 --port 8002
```

## Особенности реализации

### Безопасность паролей

- Пароли никогда не хранятся в открытом виде
- Используется bcrypt для хеширования
- Минимальная длина пароля проверяется при регистрации

### JWT токены

Токены содержат:
- `sub` (user_id) - ID пользователя
- `email` - Email пользователя
- `role` - Роль (user / admin)
- `exp` - Время истечения (24 часа)

### Коды подтверждения

- Генерируются 6-значные числовые коды
- Хранятся в БД временно
- Используются для подтверждения email и восстановления пароля

### Email отправка

- Асинхронная отправка через SMTP
- Настраиваемые шаблоны писем
- Обработка ошибок отправки

## Интеграция с Docker

Для запуска вместе с остальными сервисами используется `docker-compose.yaml`:

```yaml
user-service:
  build: ./services/user-service
  container_name: coworking-users
  ports:
    - "8002:8002"
  environment:
    - DATABASE_URL=postgresql://user:password@postgres:5432/users_db
    - JWT_SECRET=your-secret-key
  depends_on:
    - postgres
```

## Troubleshooting

### Проблема: Не отправляются email

**Решение**: Проверьте настройки SMTP:
- Включен ли доступ для небезопасных приложений (Gmail)
- Правильные ли учетные данные
- Доступен ли SMTP сервер

### Проблема: JWT токены не работают

**Решение**: 
- Убедитесь, что JWT_SECRET одинаковый во всех сервисах
- Проверьте формат токена: `Authorization: Bearer <token>`
- Проверьте, не истек ли токен (срок действия 24 часа)

### Проблема: Ошибки при регистрации с существующим email

**Решение**: Это ожидаемое поведение. Email должен быть уникальным.

## Планы развития

- [ ] Добавить OAuth2 (Google, GitHub)
- [ ] Реализовать refresh токены
- [ ] Добавить двухфакторную аутентификацию
- [ ] Профиль пользователя с возможностью редактирования
- [ ] История входов в систему
- [ ] Блокировка аккаунтов после N неудачных попыток

## Контакты и поддержка

Для вопросов и предложений создавайте issues в репозитории проекта.

---

**Версия**: 0.1.0  
**Дата последнего обновления**: 2025-12-07

